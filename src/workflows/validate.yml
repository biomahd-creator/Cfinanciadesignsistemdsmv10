name: Validate Design System

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run TypeScript type check (tsc --noEmit)
        run: npm run typecheck

  build-lib:
    name: Library Build Validation
    runs-on: ubuntu-latest
    needs: typecheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build library (vite build --config vite.config.lib.ts)
        run: npm run build:lib

      - name: Verify dist-lib output exists
        run: |
          if [ ! -d "dist-lib" ]; then
            echo "ERROR: dist-lib directory was not created"
            exit 1
          fi
          echo "dist-lib contents:"
          ls -la dist-lib/
          echo ""
          echo "Build output size:"
          du -sh dist-lib/

  circular-deps:
    name: Circular Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Check for circular dependencies (madge)
        run: npm run check:circular

  validate-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [typecheck, build-lib, circular-deps]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "=== Validation Summary ==="
          echo "TypeScript:     ${{ needs.typecheck.result }}"
          echo "Library Build:  ${{ needs.build-lib.result }}"
          echo "Circular Deps:  ${{ needs.circular-deps.result }}"
          echo "========================="
          if [ "${{ needs.typecheck.result }}" != "success" ] || \
             [ "${{ needs.build-lib.result }}" != "success" ] || \
             [ "${{ needs.circular-deps.result }}" != "success" ]; then
            echo "One or more validation steps failed!"
            exit 1
          fi
          echo "All validations passed!"